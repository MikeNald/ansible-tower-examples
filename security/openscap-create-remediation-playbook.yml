- hosts: oscap_target

  vars:
    oscap_profile: xccdf_org.ssgproject.content_profile_standard
    oscap_policy: ssg-rhel7-ds.xml
  become: true
  
  tasks:

  - name: create openscap remediation playbook based on profile 
    command: oscap xccdf generate fix \
        --fix-type ansible \
        --profile {{ oscap_profile }} \
        --output /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml \
        /usr/share/xml/scap/ssg/content/{{ oscap_policy }}
  
  - name: fixing permission on output playbook
    file:
      path: /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml
      owner: ops
      group: ops
      mode: 0755
    
  - name: install git 
    yum:
      name: git
      state: present
       
  - name: accept ssh keys for git
    shell: ssh-keyscan -H github.com >> /etc/ssh/ssh_known_hosts
    
  - name: cloning git repo locally
    git:
     repo: ssh://git@github.com/MikeNald/ansible-tower-examples.git
     dest: /home/ops/ansible-tower-examples
     key_file: /home/ops/.ssh/id_rsa
     accept_hostkey: yes
     force: yes  
  
  - name: fixing permission on git repo
    file:
      path: /home/ops/ansible-tower-examples
      owner: ops
      group: ops
      mode: 0755      
      recurse: yes
  
  - name: copy ansible playbook to local gitepo  folder
    copy:
     src: /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml
     dest: /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml         
     remote_src: yes
     owner: ops
     group: ops
     mode: 0755
     
  - name: copying report to local git folder
    copy:
     src: /tmp/oscap-report.html
     dest: /home/ops/ansible-tower-examples/security/report/{{ inventory_hostname }}-scan-xccdf-report.html
     remote_src: yes
     owner: ops
     group: ops
     mode: 0755
    
      
  - name: replace target host with correct target  
    replace:
     path: /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml
     regexp: '- hosts: all'
     replace: '- hosts: oscap_target'   
     
  - name: delete when ansible_user condition
    lineinfile:
     path: /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml
     regexp: 'when: ansible_user == "root"'
     state: absent      
     
  - name: delete root user configuration block 
    lineinfile:
     path: /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml
     regexep: "{{ item }}"
     state: absent
     with_items:
     - name: "Fail if user is not root"
     - fail:
     - msg: 'Root account required to read root $PATH'
     - when: ansible_user != "root"
     - tags:
     - - accounts_root_path_dirs_no_write
     - - low_severity
     - - restrict_strategy
     - - low_complexity
     - - medium_disruption
     - - CCE-80200-9
     - - NIST-800-53-CM-6(b)

     
  - name: add new playbook to git 
    shell: cd /home/ops/ansible-tower-examples/; git add "{{ item }}"          
    with_items:
    - /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml 
    - /home/ops/ansible-tower-examples/security/report/{{ inventory_hostname }}-scan-xccdf-report.html  
    
  - name: git commit 
    shell: cd /home/ops/ansible-tower-examples/; git commit -m "add new playbook for fixing sec issue on host {{ inventory_hostname }}"

  - name: git push
    shell: cd /home/ops/ansible-tower-examples/; git push
    become_user: ops
   
#  - name: delete local git repo folder
#    command: rm -rf /home/ops/ansible-tower-examples/
    
#  - name: uninstall git
#    yum:
#      name: git
#      state: removed
