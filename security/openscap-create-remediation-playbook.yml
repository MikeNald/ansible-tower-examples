- hosts: oscap_target

  vars:
    oscap_profile: xccdf_org.ssgproject.content_profile_standard
    oscap_policy: ssg-rhel7-ds.xml
  become: true
  
  tasks:

  - name: create openscap remediation playbook
    command: oscap xccdf generate fix \
        --fix-type ansible \
        --profile {{ oscap_profile }} \
        --output /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml \
        /usr/share/xml/scap/ssg/content/{{ oscap_policy }}
  
  - name: fixing permission on output playbook
    file:
      path: /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml
      owner: ops
      group: ops
      mode: 0755
    
  - name: install git 
    yum:
      name: git
      state: present
       
  - name: accept ssh keys for git
    shell: ssh-keyscan -H github.com >> /etc/ssh/ssh_known_hosts
    
  - name: cloning git repo locally
    git:
     repo: ssh://git@github.com/MikeNald/ansible-tower-examples.git
     dest: /home/ops/ansible-tower-examples
     key_file: /home/ops/.ssh/id_rsa
     accept_hostkey: yes
     force: yes  
  
  - name: fixing permission on git repo
    file:
      path: /home/ops/ansible-tower-examples
      owner: ops
      group: ops
      mode: 0755      
  
  - name: copy ansible playbook to local git repo folder
    copy:
     src: /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml
     dest: /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml         
     
  - name: download report
    copy:
     src: /tmp/oscap-report.html
     dest: /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-scan-xccdf-report.html
     
  - name: add new playbook to git 
    command: git add /home/ops/ansible-tower-examples/security/{{ inventory_hostname }}-standard-rhel7-role.yml          

  - name: git commit 
    command: git commit -m "add new playbook for fixing sec issue on host {{ inventory_hostname }}"

  - name: git push
    command: git push 

  - name: delete local git repo folder
    command: rm -rf /home/ops/ansible-tower-examples/
    
  - name: uninstall git
    yum:
      name: git
      state: removed
