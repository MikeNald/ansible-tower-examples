- hosts: all

  vars:
    oscap_profile: xccdf_org.ssgproject.content_profile_standard
    oscap_policy: ssg-rhel7-ds.xml

  tasks:

  - name: install openscap scanner
    package:
      name: "{{ item }}"
      state: latest
    with_items:
    - openscap-scanner
    - scap-workbench
    - scap-security-guide

  - block:
    - name: run openscap evaluation
      command: oscap xccdf eval \
        --profile {{ oscap_profile }} \
        --results-arf /tmp/oscap-arf.xml \
        --report /tmp/oscap-report.html \
        --fetch-remote-resources \
        /usr/share/xml/scap/ssg/content/{{ oscap_policy }}.xml
  
  - block:
    - name: create openscap remediation playbook
      command: oscap xccdf generage fix \
        --fix-type ansible
        --profile {{ oscap_profile }} \
        --output /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml
        /usr/share/xml/scap/ssg/content/{{ oscap_policy }}.xml

    always:
    - name: download report
      fetch:
        src: /tmp/oscap-report.html
        dest: ../oscap-reports/{{ inventory_hostname }}-scan-xccdf-report.html
        flat: yes
    
    always:
    - name: download ansible playbook
      fetch:
        src: /tmp/{{ inventory_hostname }}-standard-rhel7-role.yml
        dest: ../home/mike/ansible-tower-examples/{{ inventory_hostname }}-standard-rhel7-role.yml
        flat: yes
   
    always:
    - git:
        repo: 'git@github.com:MikeNald/ansible-tower-examples.git'
        dest: /home/mike
        update: yes

  - name:  git config
    command: git config user.name MikeNald \ 
             git config git remote set-url origin git@github.com:MikeNald/ansible-tower-examples.git

  - name: add new playbook to git
    command: git add ../home/mike/ansible-tower-examples/{{ inventory_hostname }}-standard-rhel7-role.yml 
            

  - name: git commit 
    command: git commit -m "add new playbook for fixing sec issue on host {{ inventory_hostname }}"

  - name: git push
    command: git push 
